<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>一人公司 · 商业体质诊断</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;600;700;900&display=swap');

        /* 锁定页面滚动，防止手机端橡皮筋效果和晃动 */
        body, html {
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: #f8fafc;
            font-family: 'Noto Serif SC', 'Songti SC', serif;
            -webkit-font-smoothing: antialiased;
        }

        .font-sans-ui { font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif; }
        
        /* 动画定义 */
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* 按钮样式 */
        .btn-primary { 
            background: linear-gradient(135deg, #1e3a8a 0%, #172554 100%); 
            color: white; 
            transition: all 0.2s;
            font-family: 'PingFang SC', sans-serif; 
        }
        .btn-primary:active { transform: scale(0.98); }
        .btn-primary:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; box-shadow: none; }
        
        /* 选项卡片样式 */
        .option-card { transition: all 0.2s; cursor: pointer; border: 1px solid #e2e8f0; }
        .option-card:active { background-color: #f1f5f9; transform: scale(0.99); }
        .option-card.selected { border-color: #1e3a8a; background-color: #eff6ff; color: #1e3a8a; font-weight: 700; ring: 1px solid #1e3a8a; }

        /* 隐藏滚动条但允许滚动 */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* 核心容器适配 */
        #app-container {
            height: 100dvh; 
            width: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        /* 内容区域滚动 */
        .scrollable-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 40px; 
        }
    </style>
</head>
<body>

    <!-- 全局背景 -->
    <div class="fixed inset-0 bg-slate-50 z-[-1]"></div>

    <!-- 主应用容器 -->
    <div id="app-container" class="max-w-2xl mx-auto bg-white shadow-2xl relative">
        
        <!-- 顶部进度条 -->
        <div id="progressBarContainer" class="hidden w-full h-1 bg-slate-100 absolute top-0 left-0 z-20">
            <div id="progressBar" class="h-full bg-indigo-900 transition-all duration-300 ease-out" style="width: 0%"></div>
        </div>

        <!-- 1. 首页 -->
        <div id="startPage" class="scrollable-content flex flex-col justify-center items-center text-center p-8 fade-in h-full">
            <div class="w-20 h-20 bg-indigo-950 rounded-full flex items-center justify-center mb-6 text-4xl shadow-xl text-white ring-4 ring-indigo-50">
                🧬
            </div>
            <h1 class="text-2xl md:text-3xl font-black text-indigo-950 mb-3 tracking-tight">一人公司 · 商业体质诊断</h1>
            <p class="text-slate-500 mb-8 text-base font-medium italic">“从生存到系统，找到阻碍你收入跃迁的那个卡点”</p>
            
            <div class="bg-slate-50 p-6 rounded-2xl text-left text-slate-600 mb-8 w-full border border-slate-100 shadow-sm">
                <p class="font-bold text-slate-900 mb-3 text-sm border-b border-slate-200 pb-2 font-sans-ui">📋 测评说明</p>
                <ul class="space-y-4 font-sans-ui text-xs md:text-sm">
                    <li class="flex items-start gap-3">
                        <span class="text-sm mt-0.5">🏗️</span> 
                        <div><strong class="text-slate-800">全维扫描</strong><p class="text-slate-500 mt-0.5">包含「生存状态扫描」与「核心能力体检」两部分。</p></div>
                    </li>
                    <li class="flex items-start gap-3">
                        <span class="text-sm mt-0.5">🧠</span> 
                        <div><strong class="text-slate-800">智能适配</strong><p class="text-slate-500 mt-0.5">系统会根据你的生存阶段，自动适配评分逻辑，确保诊断精准。</p></div>
                    </li>
                    <li class="flex items-start gap-3">
                        <span class="text-sm mt-0.5">🤝</span> 
                        <div><strong class="text-slate-800">诚实原则</strong><p class="text-slate-500 mt-0.5">请根据当前真实业务现状作答，而非“未来计划”。</p></div>
                    </li>
                </ul>
            </div>

            <button onclick="checkCodeAndStart()" class="btn-primary font-bold py-4 w-full rounded-xl text-lg shadow-lg hover:shadow-xl transform transition-all font-sans-ui tracking-wide">
                开始深度扫描
            </button>
            
            <div class="mt-8 text-[10px] text-slate-300 font-sans-ui">
                © 安清酉 · 版权所有
            </div>
        </div>

        <!-- 2. 答题页 -->
        <div id="quizPage" class="hidden flex-col h-full relative">
            <div class="scrollable-content p-6 md:p-8">
                <div class="mb-4 pt-4">
                    <div class="flex justify-between items-center mb-4 font-sans-ui">
                        <span id="sectionTag" class="text-[10px] font-bold tracking-wider uppercase bg-indigo-50 text-indigo-700 px-3 py-1 rounded-full border border-indigo-100">生存扫描</span>
                        <span class="text-xs text-slate-400 font-bold tracking-widest"><span id="currQ">1</span> / <span id="totalQ">50</span></span>
                    </div>
                    <h2 id="questionText" class="text-xl md:text-2xl font-bold text-indigo-950 leading-snug min-h-[4rem] flex items-center">...</h2>
                </div>
                <div id="optionsBox" class="space-y-3 font-sans-ui pb-20"></div>
            </div>

            <div class="absolute bottom-0 left-0 w-full p-4 bg-white/95 backdrop-blur-sm border-t border-slate-50 flex justify-between items-center font-sans-ui z-10">
                <button onclick="prevQuestion()" id="prevBtn" class="text-slate-400 hover:text-slate-600 text-xs font-bold px-4 py-2 rounded-lg transition-colors hidden">← 上一题</button>
                <button onclick="nextQuestion()" id="nextBtn" disabled class="btn-primary py-3 px-8 rounded-xl font-bold text-sm ml-auto shadow-lg">下一题</button>
            </div>
        </div>

        <!-- 2.5 中途插页 -->
        <div id="interstitialPage" class="hidden flex-col justify-center items-center h-full p-8 text-center fade-in bg-slate-50">
            <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mb-6 text-3xl shadow-md border border-slate-100">🔒</div>
            <h3 class="text-xl font-bold text-indigo-950 mb-4">已开启「0-1 聚焦模式」</h3>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 w-full text-left mb-8">
                <p class="text-sm text-slate-600 leading-relaxed text-justify">
                    为了确保诊断精准，本次测评将<strong>暂不涉及</strong>「系统力」与「交付力」等扩张期维度。<br><br>
                    请放心，当你跑通最小闭环（MVP）并实现稳定盈利后，再次测评即可自动解锁全维视角。
                </p>
            </div>
            <button onclick="resumeQuiz()" class="btn-primary py-3 px-10 rounded-xl font-bold text-sm shadow-lg font-sans-ui">继续答题</button>
        </div>

        <!-- 3. 结果页 -->
        <div id="resultPage" class="hidden h-full w-full bg-white z-30 flex-col overflow-hidden">
            <div class="scrollable-content">
                <!-- 头部卡片 -->
                <div class="bg-[#0f172a] text-white p-6 md:p-8 relative overflow-hidden shrink-0">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-indigo-600 rounded-full blur-[80px] opacity-20 translate-x-10 -translate-y-10"></div>
                    
                    <div class="relative z-10 pt-4">
                        <div class="flex justify-between items-start mb-6">
                            <div class="flex gap-2">
                                <div class="text-[10px] uppercase tracking-[0.2em] text-slate-400 font-bold border border-slate-700 px-3 py-1.5 rounded-full bg-slate-800/50 font-sans-ui">当前商业画像</div>
                                <!-- 阶段标签 -->
                                <div id="stageLabel" class="text-[10px] uppercase tracking-wider text-white font-bold px-3 py-1.5 rounded-full bg-indigo-600 font-sans-ui hidden">起步期 (0-1)</div>
                            </div>
                            <div class="text-right">
                                <div class="flex items-baseline justify-end gap-1 font-sans-ui">
                                    <span class="text-5xl font-black text-white tracking-tighter" id="userScoreVal">0</span>
                                    <span class="text-sm text-slate-400 font-medium">/100</span>
                                </div>
                                <div class="text-[10px] text-slate-400 font-medium font-sans-ui mt-1">商业健康总分</div>
                            </div>
                        </div>
                        <h2 id="resultTitle" class="text-3xl md:text-4xl font-black mb-3 text-transparent bg-clip-text bg-gradient-to-r from-white to-slate-400 tracking-tight">...</h2>
                        <p id="resultDesc" class="text-xs md:text-sm text-slate-300 leading-relaxed opacity-90 font-light italic border-l-2 border-indigo-500 pl-3">...</p>
                    </div>
                </div>

                <div class="p-6 space-y-8 pb-24">
                    <!-- 1. 核心图表 -->
                    <div class="bg-white border border-slate-100 rounded-2xl p-4 shadow-sm">
                        <div class="h-60 w-full relative flex justify-center">
                            <canvas id="radarChart"></canvas>
                        </div>
                    </div>

                    <!-- 2. 维度定义与得分 -->
                    <div>
                        <h3 class="font-bold text-slate-900 text-sm mb-4 flex items-center gap-2 uppercase tracking-wide font-sans-ui"><span class="text-base">📊</span> 六维能力得分</h3>
                        <div id="scoreCards" class="grid grid-cols-2 gap-3"></div>
                    </div>

                    <!-- 3. 深度诊断分析 -->
                    <div class="bg-slate-50 border border-slate-100 rounded-2xl p-6">
                        <h3 class="font-bold text-slate-900 text-sm mb-4 flex items-center gap-2 uppercase tracking-wide font-sans-ui"><span class="text-base">🩺</span> 深度诊断分析</h3>
                        <div id="diagnosisText" class="text-sm text-slate-700 leading-7 space-y-4 text-justify"></div>
                    </div>

                    <!-- 4. 关键行动 -->
                    <div class="bg-[#f0f9ff] border border-sky-100 rounded-2xl p-6 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-24 h-24 bg-sky-200 rounded-full blur-2xl opacity-30"></div>
                        <h3 class="font-bold text-sky-900 text-sm mb-4 flex items-center gap-2 uppercase tracking-wide relative z-10 font-sans-ui"><span class="w-1 h-3 bg-sky-600 rounded-full"></span> 下一步关键行动</h3>
                        <div id="actionPlan" class="space-y-4 relative z-10"></div>
                    </div>

                    <!-- 5. 附录：定义 (新增) -->
                    <div class="border-t border-slate-100 pt-8">
                        <h3 class="font-bold text-slate-900 text-sm mb-6 uppercase tracking-wide font-sans-ui text-center">附录：一人公司 · 六维增长模型定义</h3>
                        <div class="space-y-5 font-sans-ui">
                            <div>
                                <h4 class="text-xs font-bold text-indigo-900 mb-1">1. 定位力</h4>
                                <p class="text-xs text-slate-500 leading-relaxed">你在市场生态中的生态位。决定了你是谁，服务谁，以及你能切走多大的蛋糕。</p>
                            </div>
                            <div>
                                <h4 class="text-xs font-bold text-indigo-900 mb-1">2. 产品力</h4>
                                <p class="text-xs text-slate-500 leading-relaxed">你交付价值的载体。不仅指产品本身，还包括定价结构和解决方案的完整性。</p>
                            </div>
                            <div>
                                <h4 class="text-xs font-bold text-indigo-900 mb-1">3. 吸引力</h4>
                                <p class="text-xs text-slate-500 leading-relaxed">让陌生人发现你的能力。即流量获取、内容传播和品牌曝光的效率。</p>
                            </div>
                            <div>
                                <h4 class="text-xs font-bold text-indigo-900 mb-1">4. 转化力</h4>
                                <p class="text-xs text-slate-500 leading-relaxed">让流量变成现金的能力。涉及信任建立、销售话术和临门一脚的成交设计。</p>
                            </div>
                            <div>
                                <h4 class="text-xs font-bold text-indigo-900 mb-1">5. 交付力</h4>
                                <p class="text-xs text-slate-500 leading-relaxed">兑现承诺并制造惊喜的能力。决定了口碑、复购和客户生命周期价值。</p>
                            </div>
                            <div>
                                <h4 class="text-xs font-bold text-indigo-900 mb-1">6. 系统力</h4>
                                <p class="text-xs text-slate-500 leading-relaxed">让业务脱离你个人时间运转的能力。包括流程SOP、工具自动化和财务健康度。</p>
                            </div>
                        </div>
                    </div>

                    <!-- 底部操作 -->
                    <div class="flex flex-col gap-3 pt-6 border-t border-slate-100 font-sans-ui mt-4">
                        <button onclick="downloadCard()" class="w-full py-4 bg-slate-900 text-white font-bold rounded-xl hover:bg-slate-800 text-sm transition-colors shadow-lg flex items-center justify-center gap-2">
                            <span>📥</span> 生成完整诊断报告 (图片)
                        </button>
                        <button onclick="location.reload()" class="w-full py-3 text-slate-400 font-bold rounded-xl hover:text-slate-600 text-xs transition-colors">
                            重新测试
                        </button>
                        <div class="text-center text-[10px] text-slate-300 mt-2">
                            © 安清酉 · 商业体质诊断系统
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. 分析中弹窗 -->
    <div id="analyzingModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-white/90 backdrop-blur-sm fade-in font-sans-ui">
        <div class="bg-white p-8 rounded-2xl shadow-2xl flex flex-col items-center text-center w-64 border border-slate-100">
            <div class="w-10 h-10 border-4 border-slate-100 border-t-indigo-900 rounded-full animate-spin mb-4"></div>
            <h3 class="text-base font-bold text-slate-800 mb-1">正在生成画像...</h3>
            <p class="text-[10px] text-slate-500" id="loadingText">分析商业模型...</p>
        </div>
    </div>

    <!-- 5. 兑换码解锁弹窗 -->
    <div id="unlockModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-slate-900/80 backdrop-blur-sm fade-in font-sans-ui p-4">
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl w-full max-w-sm relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-indigo-500 to-purple-500"></div>
            <div class="text-center mb-6">
                <div class="w-14 h-14 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl">🔑</div>
                <h3 class="text-lg font-bold text-slate-900">开启商业诊断</h3>
                <p class="text-xs text-slate-500 mt-2">本测评为付费内容。<br>请输入您的专属兑换码以开始答题。</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <input type="text" id="redeemCodeInput" placeholder="请输入兑换码" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 text-center text-base font-bold tracking-widest uppercase placeholder:text-sm placeholder:font-normal placeholder:tracking-normal appearance-none">
                    <p id="redeemError" class="text-xs text-red-500 text-center mt-2 hidden">兑换码无效，请检查后重试</p>
                </div>
                <button onclick="verifyCode()" class="w-full py-3 bg-indigo-900 text-white font-bold rounded-xl hover:bg-indigo-800 transition-colors shadow-lg text-sm">
                    立即验证并开始
                </button>
            </div>
            
            <div class="mt-6 text-center border-t border-slate-100 pt-4">
                <p class="text-xs text-slate-400">还没有兑换码？<a href="https://xhslink.com/m/9zlRIGza06v" target="_blank" class="text-indigo-600 hover:underline font-bold">点击获取</a></p>
            </div>
        </div>
    </div>

    <!-- 6. 图片生成展示弹窗 (新增) -->
    <div id="imageModal" class="fixed inset-0 z-[70] hidden flex flex-col items-center justify-center bg-slate-900/95 backdrop-blur-sm fade-in font-sans-ui p-4">
        <div class="relative w-full max-w-md bg-transparent flex flex-col items-center">
            <div class="bg-white rounded-xl p-2 shadow-2xl overflow-hidden max-h-[80vh] overflow-y-auto mb-4 w-full">
                <img id="generatedImage" src="" alt="诊断报告" class="w-full h-auto rounded-lg block">
            </div>
            <p class="text-white text-sm font-bold animate-pulse mb-4">👆 长按上方图片即可保存到相册</p>
            <button onclick="closeImageModal()" class="bg-white/10 text-white px-6 py-2 rounded-full text-sm hover:bg-white/20 transition-colors border border-white/20">
                关闭
            </button>
        </div>
    </div>

    <script>
        // --- 兑换码配置 ---
        const VALID_CODES = [
            "Z739-RTVR", "QYFB-8D7X", "QVKW-TYAW", "Z3S5-KNHF", "4F2M-XC67", "F7FN-GHNJ", "HF5C-6J5J", "DU9C-PGWW", "JCF3-JDVZ", "WQHP-HP2J",
            "TB58-UWBT", "F7JS-RQR8", "38AT-DMU5", "767N-8XCE", "M9D9-RT53", "GGQL-4PFC", "SGXH-YZD8", "JX7V-ZFWH", "3CQM-79S6", "TFSF-A769",
            "YS93-59PG", "QNAG-D7UA", "DNE2-3B2W", "7WNB-Z2E4", "ZS5A-9S8S", "Z9FT-HEX2", "TJXR-X5PN", "KUDK-FRFT", "6PJ9-VNH4", "WRQN-JEYY",
            "V393-CY2A", "VEM9-LQDH", "6EN9-N7C8", "Z24Z-6RR5", "3JNB-SWXZ", "JZVL-JUP6", "9NX7-FPCQ", "ZT2W-DGG3", "THN9-Q6MD", "DG2P-P9JK",
            "DKLV-2PZD", "V5RS-EBW4", "MN5A-4FUA", "H36H-723G", "7D4U-8HTK", "2ZZW-2HMA", "U8YN-XPR2", "2JB9-J8RB", "GRU5-H8VR", "YVKD-X7XE",
            "JQ7W-TDPF", "T7GG-2L2E", "6RCU-3RNP", "56Y7-PJ5Q", "FM9A-7LUG", "646W-LFP7", "R5TH-YJ8U", "5BYD-6MFF", "3MJW-PTEQ", "P2N5-XHPP",
            "E3JE-C9YZ", "5T3C-DCP2", "N3TH-KP8X", "KSPD-QEC8", "5W6Z-4JEG", "X7K6-V6NC", "PSVE-LF52", "288S-6FRF", "UNFS-EYQ4", "WESX-5CAR",
            "FD34-YX35", "25ZF-TMAT", "X4N6-U44Z", "3336-GZMX", "8WQZ-7USE", "ZNTE-UBV7", "7RSW-WVR4", "9WRL-QHWV", "NN4G-DNDU", "AJLY-UCK6",
            "J7BX-EVZP", "B3Z9-XL93", "MPRU-VTMD", "RRKK-DP5D", "TW9W-6MGU", "TU7G-STXT", "3BHP-P4JK", "7QQX-E9VH", "YWNR-PUG9", "C3CX-AJBV",
            "4VTP-X8GD", "J2KG-WY3Z", "9E5M-29NL", "AWEH-FHKC", "6XGF-2ED7", "R98U-DDF5", "LLDJ-FUAG", "GGDL-PBSA", "2WUR-5Y7T", "X986-DVUJ"
        ];

        let isUnlocked = localStorage.getItem('isUnlocked') === 'true';

        // 维度定义字典
        const DIMENSION_DEFS = {
            "定位力": "差异化与生态位选择",
            "产品力": "解决问题的交付方案",
            "吸引力": "流量获取与内容能力",
            "转化力": "信任构建与成交效率",
            "交付力": "客户体验与复购机制",
            "系统力": "效率杠杆与抗风险力"
        };

        const questions = [
            { section: "生存扫描", type: "choice", text: "除去工资，你目前的“一人公司/副业”收入状况是？", options: ["几乎没有，还在投入期", "偶尔有，但不稳定", "稳定，但还没超过主业工资", "稳定，且已超过主业工资"] },
            { section: "生存扫描", type: "choice", text: "关于你的“产品/服务”标准化程度？", options: ["还在想卖什么，没定型", "高度定制，每次交付都要重来一遍", "半标准化，有框架但需人工调整", "完全标准化，有SOP或直接卖成品"] },
            { section: "生存扫描", type: "choice", text: "如果停止主动工作一周，你的“业务流”会怎样？", options: ["收入归零，手停口停", "会有积压，回来得疯狂补救", "基本自动运转，影响不大"] },
            { section: "生存扫描", type: "choice", text: "你现在最痛苦的问题是？", options: ["不知道干啥 / 找不到定位", "没人买 / 流量进不来", "太忙了 / 交付做不过来", "增长不动 / 到了天花板"] },
            { section: "生存扫描", type: "choice", text: "你的新客户主要怎么来的？", options: ["还没什么客户 / 纯靠运气 / 随缘接单", "主要靠我主动出击 / 费力推销 / 疯狂加人", "靠内容或投放自动吸引 / 系统获客", "大部分是慕名而来 / 朋友推荐 / 品牌获客"] },
            { section: "生存扫描", type: "choice", text: "当你向客户报价时，通常的情况是？", options: ["不敢报高价，怕客户跑了", "经常被客户砍价，为了成交只能妥协", "一口价，爱买不买，我有底气", "我有阶梯价，客户总能找到适合的"] },
            { section: "生存扫描", type: "choice", text: "你的客户生命周期通常是？", options: ["一锤子买卖，买完就走", "偶尔回头，看缘分", "有设计好的路径，会持续复购或升级"] },
            { section: "生存扫描", type: "choice", text: "你每天花在“非核心业务”（如排版、发票、扯皮）上的时间？", options: ["占了一大半，感觉自己像个打杂的", "约30%，有些不得不做", "很少，都外包或用工具解决了"] },
            { section: "生存扫描", type: "choice", text: "如果你的赛道突然涌入一批低价竞争者，你会？", options: ["很慌，只能跟着降价", "有点担心，但觉得还能撑一撑", "无所谓，我的壁垒他们抄不走"] },
            { section: "生存扫描", type: "choice", text: "你做“一人公司”的终极目标是？", options: ["赚点零花钱，帮补家用", "取代上班，通过自由职业养活自己", "做成系统，即使我不干活也有被动收入"] },
            { section: "定位力", type: "scale", dim: 0, text: "我非常清楚我的产品解决了客户的哪个具体痛点，而不是“大概有用”。" },
            { section: "定位力", type: "scale", dim: 0, text: "我能立刻说出 3 个竞争对手，并清楚我比他们强在哪里。" },
            { section: "定位力", type: "scale", dim: 0, text: "我选的赛道，是我即使不赚钱也愿意长期投入的领域。" },
            { section: "定位力", type: "scale", dim: 0, text: "我有独特的“个人标签”：当大家聊到某个细分领域（如：PPT设计/情感咨询）时，朋友圈里的人能第一时间想到我。" },
            { section: "定位力", type: "scale", dim: 0, text: "我有明确的“不服务清单”，对于不合适的客户我会直接拒绝。" },
            { section: "定位力", type: "scale", dim: 0, text: "我非常清楚我的目标客户平时聚集在哪里（哪个平台/社群/线下场景）。" },
            { section: "定位力", type: "scale", dim: 0, text: "我有清晰的“电梯演讲”：能在30秒内向陌生人讲清“我帮谁、解决什么问题、达成什么结果”。" },
            { section: "产品力", type: "scale", dim: 1, text: "我有一个低门槛的入门产品（引流款），方便客户低成本试错。" },
            { section: "产品力", type: "scale", dim: 1, text: "我的核心产品有独特的“独家秘方”或方法论，别人很难直接复制。" },
            { section: "产品力", type: "scale", dim: 1, text: "我收集了至少 10 个真实的客户好评/见证，并整理成了素材。" },
            { section: "产品力", type: "scale", dim: 1, text: "我的产品交付流程已经形成了文档或SOP，不需要每次都动脑子。" },
            { section: "产品力", type: "scale", dim: 1, text: "我会定期根据客户反馈迭代产品，而不是一套东西卖万年。" },
            { section: "产品力", type: "scale", dim: 1, text: "我的产品定价结构合理，既有引流款，也有高利润款。" },
            { section: "产品力", type: "scale", dim: 1, text: "我有一个“明星产品”贡献了超过 50% 的收入，而不是什么都卖一点。" },
            { section: "吸引力", type: "scale", dim: 2, text: "我搭建了持续获客的“流量管道”（如持续更新的内容、投放或激励转介绍），而不是坐等客户上门或纯靠运气碰单。" },
            { section: "吸引力", type: "scale", dim: 2, text: "即使我不工作时，互联网上也有内容在持续为我带来曝光。" },
            { section: "吸引力", type: "scale", dim: 2, text: "我清楚哪个渠道的转化率最高，并把精力主要花在那里。" },
            { section: "吸引力", type: "scale", dim: 2, text: "我不依赖单一平台，如果大号被封，我有备用方案联系客户。" },
            { section: "吸引力", type: "scale", dim: 2, text: "我发的内容不仅仅是干货，也展示了我的人格魅力和价值观。" },
            { section: "吸引力", type: "scale", dim: 2, text: "我有意识地在构建私域流量池（如微信好友/社群），而不是只在公域裸奔。" },
            { section: "吸引力", type: "scale", dim: 2, text: "我会追踪内容数据（阅读/点赞/转化），知道什么选题有效，而不是凭感觉发。" },
            { section: "转化力", type: "scale", dim: 3, text: "我的成交环节没有“人工卡点”，客户不需要问“怎么买”或等我回复，就能直接完成支付/预约。" },
            { section: "转化力", type: "scale", dim: 3, text: "我不害怕谈钱，报价时我内心非常坦荡。" },
            { section: "转化力", type: "scale", dim: 3, text: "面对客户的“太贵了”，我有一套成熟的话术或逻辑去应对。" },
            { section: "转化力", type: "scale", dim: 3, text: "我有设计“临门一脚”的动作（如限时/限量/赠品）来促成下单。" },
            { section: "转化力", type: "scale", dim: 3, text: "对于咨询后未成交的客户，我有后续的跟进机制，而不是直接放弃。" },
            { section: "转化力", type: "scale", dim: 3, text: "我有一套筛选机制，能把精力集中在那些真正认可价值的优质客户身上。" },
            { section: "转化力", type: "scale", dim: 3, text: "我会记录并分析客户“不买”的原因，用来优化后续话术。" },
            { section: "交付力", type: "scale", dim: 4, advanced: true, text: "在合作开始前，我会明确告知客户预期的结果和风险，管理好期望值。" },
            { section: "交付力", type: "scale", dim: 4, advanced: true, text: "我经常能给客户提供超出预期的“小惊喜”（超额交付）。" },
            { section: "交付力", type: "scale", dim: 4, advanced: true, text: "面对客户的不满或投诉，我有情绪稳定的处理预案。" },
            { section: "交付力", type: "scale", dim: 4, advanced: true, text: "我的老客户转介绍率很高，很多新单子是朋友推荐的。" },
            { section: "交付力", type: "scale", dim: 4, advanced: true, text: "我有把常见问题（FAQ）整理成文档，避免重复回答同一个问题。" },
            { section: "交付力", type: "scale", dim: 4, advanced: true, text: "我有一套应对突发状况的Plan B，即使生病或断网，业务也能维持最低限度运转。" },
            { section: "系统力", type: "scale", dim: 5, advanced: true, text: "我有极强的“CEO 意识”：我会刻意计算投入产出比（ROI），对于低价值的重复性杂事，我宁愿花钱买时间，也不会为了省钱而亲力亲为。" },
            { section: "系统力", type: "scale", dim: 5, advanced: true, text: "我正在搭建“数字员工”体系：利用 AI 或自动化工具全天候处理业务（如自动发货/数据抓取），实现业务规模与我个人的工作时长解绑。" },
            { section: "系统力", type: "scale", dim: 5, advanced: true, text: "我有健康的作息，不会因为业务繁忙而长期牺牲睡眠或健康。" },
            { section: "系统力", type: "scale", dim: 5, advanced: true, text: "我会定期（如每月）复盘财务状况，清楚每一分钱的盈亏。" },
            { section: "系统力", type: "scale", dim: 5, advanced: true, text: "遇到业务低谷时，我有良好的心态调节能力，不会轻易崩盘。" },
            { section: "系统力", type: "scale", dim: 5, advanced: true, text: "我在持续学习新技能，每年都会为自己的大脑投资。" }
        ];

        let currentIdx = 0;
        let answers = new Array(questions.length).fill(null);
        let isSurvivalMode = false;
        const dimensions = ["定位力", "产品力", "吸引力", "转化力", "交付力", "系统力"];
        let finalScoresForDownload = [];

        document.getElementById('totalQ').innerText = questions.length;

        function checkCodeAndStart() {
            if (isUnlocked) {
                startQuiz();
            } else {
                document.getElementById('unlockModal').classList.remove('hidden');
            }
        }

        function verifyCode() {
            const input = document.getElementById('redeemCodeInput').value.trim().toUpperCase();
            const errorMsg = document.getElementById('redeemError');
            
            if (VALID_CODES.includes(input)) {
                isUnlocked = true;
                localStorage.setItem('isUnlocked', 'true');
                document.getElementById('unlockModal').classList.add('hidden');
                startQuiz();
            } else {
                errorMsg.classList.remove('hidden');
                document.getElementById('redeemCodeInput').classList.add('border-red-500');
                document.getElementById('redeemCodeInput').classList.add('text-red-500');
            }
        }

        document.getElementById('redeemCodeInput').addEventListener('focus', function() {
            document.getElementById('redeemError').classList.add('hidden');
            this.classList.remove('border-red-500');
            this.classList.remove('text-red-500');
        });

        function startQuiz() {
            document.getElementById('startPage').classList.add('hidden');
            document.getElementById('progressBarContainer').classList.remove('hidden');
            document.getElementById('quizPage').classList.remove('hidden');
            document.getElementById('quizPage').classList.add('flex');
            renderQuestion();
        }

        function renderQuestion() {
            const q = questions[currentIdx];
            const progress = ((currentIdx + 1) / questions.length) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('currQ').innerText = currentIdx + 1;
            document.getElementById('sectionTag').innerText = q.section;
            document.getElementById('questionText').innerText = q.text;

            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            if (currentIdx === 0) prevBtn.classList.add('hidden');
            else prevBtn.classList.remove('hidden');
            
            nextBtn.disabled = answers[currentIdx] === null;
            nextBtn.innerText = (currentIdx === questions.length - 1 || (isSurvivalMode && currentIdx === 37)) ? "生成诊断画像" : "下一题";

            const box = document.getElementById('optionsBox');
            box.innerHTML = '';

            if (q.type === 'scale') {
                const wrapper = document.createElement('div');
                wrapper.className = 'flex flex-col gap-2 mt-4';
                const row = document.createElement('div');
                row.className = 'flex gap-2';
                for(let i=1; i<=5; i++) {
                    const btn = document.createElement('button');
                    btn.className = `option-card flex-1 py-5 rounded-xl text-xl font-bold text-slate-300 bg-white ${answers[currentIdx] === i ? 'selected' : 'border-slate-200'}`;
                    btn.innerText = i;
                    btn.onclick = () => selectAnswer(i);
                    row.appendChild(btn);
                }
                wrapper.appendChild(row);
                const labels = document.createElement('div');
                labels.className = 'flex justify-between text-[10px] text-slate-400 px-1 mt-1 font-sans-ui';
                labels.innerHTML = '<span>完全不符</span><span>完全符合</span>';
                wrapper.appendChild(labels);
                box.appendChild(wrapper);
            } else {
                q.options.forEach((opt, idx) => {
                    const btn = document.createElement('button');
                    btn.className = `option-card w-full text-left p-4 md:p-5 rounded-xl text-sm font-medium bg-white ${answers[currentIdx] === idx ? 'selected' : 'border-slate-200 text-slate-600'}`;
                    btn.innerText = opt;
                    btn.onclick = () => selectAnswer(idx);
                    box.appendChild(btn);
                });
            }
        }

        function selectAnswer(val) {
            answers[currentIdx] = val;
            renderQuestion();
            setTimeout(() => {
                if (!document.getElementById('nextBtn').innerText.includes("生成")) {
                    nextQuestion();
                }
            }, 250);
        }

        function prevQuestion() {
            let target = currentIdx - 1;
            if (isSurvivalMode) {
                while(target >= 0 && questions[target].advanced) target--;
            }
            if (target >= 0) {
                currentIdx = target;
                renderQuestion();
            }
        }

        function nextQuestion() {
            if (currentIdx === 9) {
                const survivalScore = answers.slice(0, 10).reduce((a, b) => a + b, 0);
                if (survivalScore <= 15) { 
                    isSurvivalMode = true;
                    showInterstitial(); 
                    return; 
                } else {
                    isSurvivalMode = false;
                }
            }
            proceedToNext();
        }

        function showInterstitial() {
            document.getElementById('quizPage').classList.add('hidden');
            document.getElementById('interstitialPage').classList.remove('hidden');
            document.getElementById('interstitialPage').classList.add('flex');
        }

        function resumeQuiz() {
            document.getElementById('interstitialPage').classList.add('hidden');
            document.getElementById('interstitialPage').classList.remove('flex');
            document.getElementById('quizPage').classList.remove('hidden');
            proceedToNext();
        }

        function proceedToNext() {
            let nextIdx = currentIdx + 1;
            if (isSurvivalMode) {
                while (nextIdx < questions.length && questions[nextIdx].advanced) {
                    answers[nextIdx] = null;
                    nextIdx++;
                }
            }
            if (nextIdx < questions.length) {
                currentIdx = nextIdx;
                renderQuestion();
            } else {
                triggerAnalysis();
            }
        }

        function triggerAnalysis() {
            const modal = document.getElementById('analyzingModal');
            const loadingText = document.getElementById('loadingText');
            modal.classList.remove('hidden');
            const texts = ["正在计算六维能力模型...", "正在比对行业基准数据...", "正在生成关键行动建议..."];
            let i = 0;
            const interval = setInterval(() => {
                loadingText.innerText = texts[i];
                i++;
                if (i >= texts.length) clearInterval(interval);
            }, 600);
            setTimeout(() => {
                modal.classList.add('hidden');
                showResult();
            }, 2000);
        }

        let finalHealthIndex = 0;
        let finalTitle = "";

        function showResult() {
            calculateAndRender();
            document.getElementById('quizPage').classList.add('hidden');
            document.getElementById('progressBarContainer').classList.add('hidden');
            document.getElementById('resultPage').classList.remove('hidden');
            document.getElementById('resultPage').classList.add('flex');
            
            // 显示阶段标签
            const stageLabel = document.getElementById('stageLabel');
            stageLabel.classList.remove('hidden');
            if (isSurvivalMode) {
                stageLabel.innerText = "起步期 (0-1)";
                stageLabel.className = "text-[10px] uppercase tracking-wider text-white font-bold px-3 py-1.5 rounded-full bg-amber-500 font-sans-ui";
            } else {
                stageLabel.innerText = "成长期 (1-N)";
                stageLabel.className = "text-[10px] uppercase tracking-wider text-white font-bold px-3 py-1.5 rounded-full bg-emerald-500 font-sans-ui";
            }
        }

        function calculateAndRender() {
            let dimScores = [0,0,0,0,0,0];
            let dimCounts = [0,0,0,0,0,0];
            questions.forEach((q, idx) => {
                if (q.dim !== undefined && answers[idx] !== null) {
                    dimScores[q.dim] += answers[idx];
                    dimCounts[q.dim]++;
                }
            });
            let finalScores = dimScores.map((s, i) => dimCounts[i] ? Math.round((s / dimCounts[i]) * 20) : 0);
            finalScoresForDownload = finalScores;

            let validDims = isSurvivalMode ? 4 : 6;
            let totalScore = 0;
            for(let i=0; i<validDims; i++) totalScore += finalScores[i];
            finalHealthIndex = Math.round(totalScore / validDims);
            
            const diagnosis = getDiagnosis(finalScores, finalHealthIndex, isSurvivalMode);
            finalTitle = diagnosis.title;

            document.getElementById('resultTitle').innerText = diagnosis.title;
            document.getElementById('resultDesc').innerText = diagnosis.desc;
            document.getElementById('userScoreVal').innerText = finalHealthIndex;
            document.getElementById('diagnosisText').innerHTML = diagnosis.analysis;
            document.getElementById('actionPlan').innerHTML = diagnosis.actions;
            renderScoreCards(finalScores, isSurvivalMode);
            renderChart(finalScores);
        }

        function renderScoreCards(scores, isSurvival) {
            const container = document.getElementById('scoreCards');
            container.innerHTML = '';
            dimensions.forEach((name, idx) => {
                const card = document.createElement('div');
                const isLocked = isSurvival && (idx === 4 || idx === 5);
                const desc = DIMENSION_DEFS[name]; 
                
                if (isLocked) {
                    card.className = "bg-slate-50 border border-slate-100 rounded-lg p-3 flex flex-col items-center justify-center text-center opacity-60";
                    // 修改点：增加“进阶后自动解锁”
                    card.innerHTML = `<div class="text-lg mb-1 text-slate-300">🔒</div><div class="text-xs font-bold text-slate-400 font-sans-ui">${name}</div><div class="text-[10px] text-slate-400 mt-1 scale-90">进阶后自动解锁</div>`;
                } else {
                    const score = scores[idx];
                    let colorClass = score >= 80 ? "text-emerald-600" : (score >= 60 ? "text-indigo-600" : "text-amber-600");
                    card.className = "bg-white border border-slate-100 rounded-lg p-3 shadow-sm flex flex-col justify-between";
                    card.innerHTML = `
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs text-slate-600 font-bold font-sans-ui">${name}</span>
                                <span class="text-sm font-black ${colorClass} font-sans-ui">${score}</span>
                            </div>
                            <div class="text-[10px] text-slate-400 leading-tight font-sans-ui scale-90 origin-top-left mt-1">${desc}</div>
                        </div>
                    `;
                }
                container.appendChild(card);
            });
        }

        function getDiagnosis(scores, total, isSurvival) {
            const [pos, prod, attr, conv, del, sys] = scores;
            if (attr > 70 && (conv < 55 || prod < 55)) return { title: "漏水的网红", desc: "流量获取能力优于后端承接能力，存在“高曝光、低转化”的现象。", analysis: `<p><strong>⚠️ 现状观察：</strong> 数据显示，你在【吸引力】维度表现突出，意味着你具备不错的内容创作或获客直觉。然而，【产品力】或【转化力】的相对滞后，导致流量进入后难以形成有效沉淀。</p><p><strong>🔍 归因分析：</strong> 这种不平衡往往源于精力的分配偏差。在起步阶段，我们容易沉迷于可见的“虚荣指标”（如阅读量），而忽视了不可见的“信任建设”。</p>`, actions: `<div class="flex gap-3 items-start"><span class="text-indigo-900 font-mono text-xs mt-1 font-bold">01</span><div><strong class="text-slate-800 text-sm">私域沉淀</strong><p class="text-xs text-slate-600 mt-1">设计一个高价值的“诱饵资料”，将公域流量引导至微信私域，建立更深度的信任链接。</p></div></div><div class="flex gap-3 items-start"><span class="text-indigo-900 font-mono text-xs mt-1 font-bold">02</span><div><strong class="text-slate-800 text-sm">转化率优化</strong><p class="text-xs text-slate-600 mt-1">复盘最近 10 个未成交客户，优化你的报价话术或产品介绍页。</p></div></div>` };
            if (prod > 70 && (attr < 55 || pos < 55)) return { title: "羞涩的工匠", desc: "交付能力强于市场链接能力，存在“酒香也怕巷子深”的挑战。", analysis: `<p><strong>⚠️ 现状观察：</strong> 你的【产品力】得分很高，说明你是一位对自己有要求的专业人士。但【吸引力】或【定位力】的不足，表明你在市场推广方面较为保守。</p><p><strong>🔍 归因分析：</strong> 这是技术出身创业者的常见特征。我们往往误以为“好产品自己会说话”，但在信息过载的时代，这并不总是成立。</p>`, actions: `<div class="flex gap-3 items-start"><span class="text-indigo-900 font-mono text-xs mt-1 font-bold">01</span><div><strong class="text-slate-800 text-sm">最小可行性推广</strong><p class="text-xs text-slate-600 mt-1">尝试“暴力推广周”：下周禁止修改产品，强制自己每天联系 5 个潜在客户或发布一条推广内容。</p></div></div>` };
            if (pos < 50 && total > 55) return { title: "忙碌的探索者", desc: "战术勤奋，但战略聚焦度有待提升，业务线可能过于分散。", analysis: `<p><strong>⚠️ 现状观察：</strong> 你投入了大量时间精力，但【定位力】得分偏低。这通常意味着你在同时尝试多种业务，或者服务着各类需求迥异的客户。</p><p><strong>🔍 归因分析：</strong> 缺乏清晰的“不服务清单”是主要原因。因为没有聚焦，你无法形成标准化的SOP，每一次交付都像是在重新创业。</p>`, actions: `<div class="flex gap-3 items-start"><span class="text-indigo-900 font-mono text-xs mt-1 font-bold">01</span><div><strong class="text-slate-800 text-sm">聚焦细分 (Niche Down)</strong><p class="text-xs text-slate-600 mt-1">回顾过往项目，找出利润最高且你最享受的那一类，将它定义为核心业务，逐步砍掉其他杂项。</p></div></div>` };
            if (!isSurvival && sys < 55 && (attr > 60 || conv > 60)) return { title: "高负荷的独行侠", desc: "业务发展良好，但个人时间被严重挤占，系统化程度滞后。", analysis: `<p><strong>⚠️ 现状观察：</strong> 你的业务已经跑通，甚至收入可观，但【系统力】成为了明显的短板。这表现为：你不敢停下来，所有事务都高度依赖你的亲力亲为。</p><p><strong>🔍 归因分析：</strong> 你可能陷入了“自己做更放心”的思维定势。但作为一人公司的CEO，你的时间应该花在决策和核心交付上，而非重复性的行政琐事。</p>`, actions: `<div class="flex gap-3 items-start"><span class="text-indigo-900 font-mono text-xs mt-1 font-bold">01</span><div><strong class="text-slate-800 text-sm">建立SOP</strong><p class="text-xs text-slate-600 mt-1">开始记录你的工作流程。把你做对的事情写下来，让工具或外包人员来分担。</p></div></div>` };
            if (isSurvival && total < 75) return { title: "荒野求生者", desc: "处于从0到1的验证初期，商业闭环尚未完全跑通。", analysis: `<p><strong>⚠️ 现状观察：</strong> 混乱是起步期的常态。你可能面临着方向不确定、收入不稳定的双重压力。这是最艰难的阶段，但也蕴含着最大的可能性。</p><p><strong>🔍 阶段策略：</strong> 此时此刻，任何不直接带来现金流的动作（如设计Logo、装修网站）都是次要的。</p>`, actions: `<div class="flex gap-3 items-start"><span class="text-indigo-900 font-mono text-xs mt-1 font-bold">01</span><div><strong class="text-slate-800 text-sm">单点突破</strong><p class="text-xs text-slate-600 mt-1">不要试图平衡发展。选定一个最小的切口，集中所有精力搞定第一单交付。</p></div></div>` };
            if (isSurvival && total >= 75) return { title: "潜力独角兽", desc: "商业直觉敏锐，基础模型健康，只待规模化验证。", analysis: `<p><strong>🌟 状态极佳：</strong> 虽然处于起步阶段，但你的各项指标非常健康。你没有明显的短板，且定位清晰。</p><p><strong>🚀 进阶方向：</strong> 不要满足于现状。你现在可以适当增加风险偏好，尝试一些能够带来指数级增长的动作。</p>`, actions: `<div class="flex gap-3 items-start"><span class="text-indigo-900 font-mono text-xs mt-1 font-bold">01</span><div><strong class="text-slate-800 text-sm">加大油门</strong><p class="text-xs text-slate-600 mt-1">既然模型验证跑通了，现在可以适当增加投入，测试一下放大流量后的承接能力。</p></div></div>` };
            if (!isSurvival && total >= 80) return { title: "全能经营者", desc: "商业模型成熟健康，具备了规模化与资产化的基础。", analysis: `<p><strong>👏 状态极佳：</strong> 恭喜你，你已经是一人公司领域的佼佼者。你跑通了闭环，并且在各个维度都建立了壁垒。</p><p><strong>🚀 终极目标：</strong> 从“经营生意”转向“经营资产”。思考如何将你的服务产品化，实现边际成本递减。</p>`, actions: `<div class="flex gap-3 items-start"><span class="text-indigo-900 font-mono text-xs mt-1 font-bold">01</span><div><strong class="text-slate-800 text-sm">产品化 (Productize)</strong><p class="text-xs text-slate-600 mt-1">将你的服务封装成课程、软件或标准化产品，追求“睡后收入”。</p></div></div>` };
            if (!isSurvival && total >= 60 && total < 80) return { title: "稳健的耕耘者", desc: "基础扎实，但缺乏让市场尖叫的差异化亮点。", analysis: `<p><strong>📈 现状观察：</strong> 你已经跨过了生存线，业务运转平稳。但这种“平稳”可能也是一种隐患——没有突出的长板，意味着溢价能力有限。</p><p><strong>🚀 破局思路：</strong> 必须制造“尖叫点”。平庸是商业最大的敌人。与其全面平庸，不如单点极致。</p>`, actions: `<div class="flex gap-3 items-start"><span class="text-indigo-900 font-mono text-xs mt-1 font-bold">01</span><div><strong class="text-slate-800 text-sm">打造尖刀</strong><p class="text-xs text-slate-600 mt-1">选一个你最擅长的环节，把它做到行业前 5%，用这把尖刀切开更大的市场。</p></div></div>` };
            return { title: "待破局的探索者", desc: "各维度发展较为平均，尚未形成明显的竞争壁垒。", analysis: `<p><strong>⚠️ 核心症结：</strong> 你可能在试图“补短板”，这在一人公司模式下效率较低。一个人的精力有限，不可能面面俱到。</p>`, actions: `<div class="flex gap-3 items-start"><span class="text-indigo-900 font-mono text-xs mt-1 font-bold">01</span><div><strong class="text-slate-800 text-sm">长板效应</strong><p class="text-xs text-slate-600 mt-1">找出你得分最高的那一项，投入资源把它做到极致。</p></div></div>` };
        }

        let radarChart = null;
        function renderChart(data) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            const chartData = isSurvivalMode ? [...data.slice(0,4), 0, 0] : data;
            if (radarChart) radarChart.destroy();
            
            // 修改点：显式设置字体，防止挤压
            Chart.defaults.font.family = "'PingFang SC', 'Microsoft YaHei', sans-serif";
            
            radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: dimensions,
                    datasets: [{
                        label: '能力得分',
                        data: chartData,
                        backgroundColor: 'rgba(30, 58, 138, 0.15)',
                        borderColor: '#1e3a8a',
                        borderWidth: 2,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#1e3a8a',
                        pointHoverBackgroundColor: '#1e3a8a',
                        pointHoverBorderColor: '#fff',
                        pointRadius: 3
                    }]
                },
                options: {
                    scales: {
                        r: {
                            angleLines: { color: '#e2e8f0' },
                            grid: { color: '#e2e8f0' },
                            pointLabels: { 
                                font: { size: 11, weight: 'bold' }, // 稍微调大字体
                                color: '#64748b' 
                            },
                            suggestedMin: 0,
                            suggestedMax: 20,
                            ticks: { display: false }
                        }
                    },
                    plugins: { legend: { display: false } },
                    maintainAspectRatio: false,
                }
            });
        }

        // --- 增强版图片生成逻辑 (重构布局 + 弹窗展示) ---
        
        function downloadCard() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // 设定长图尺寸
            const width = 750; // 标准手机宽度
            const height = 1350; 
            canvas.width = width;
            canvas.height = height;

            // 1. 绘制背景
            ctx.fillStyle = '#f8fafc';
            ctx.fillRect(0, 0, width, height);
            
            // 顶部深色块
            ctx.fillStyle = '#0f172a';
            ctx.fillRect(0, 0, width, 300);

            // 2. 绘制头部信息
            ctx.textAlign = 'center';
            
            // 标题
            ctx.fillStyle = '#94a3b8';
            ctx.font = 'bold 22px "PingFang SC", sans-serif';
            ctx.fillText('一人公司 · 商业体质诊断', width / 2, 60);

            // 分数
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 90px "PingFang SC", sans-serif';
            ctx.fillText(finalHealthIndex, width / 2, 160);
            
            ctx.font = '18px "PingFang SC", sans-serif';
            ctx.fillStyle = '#64748b';
            ctx.fillText('商业健康总分', width / 2, 195);

            // 阶段标签 (绘制圆角矩形)
            const stageText = isSurvivalMode ? "起步期 (0-1)" : "成长期 (1-N)";
            const stageColor = isSurvivalMode ? "#f59e0b" : "#10b981";
            ctx.fillStyle = stageColor;
            roundRect(ctx, width/2 - 60, 220, 120, 30, 15, true);
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 12px "PingFang SC", sans-serif';
            ctx.fillText(stageText, width / 2, 240);

            // 诊断称号
            ctx.font = 'bold 40px "PingFang SC", sans-serif';
            ctx.fillStyle = '#1e293b';
            ctx.fillText(finalTitle, width / 2, 360);

            // 3. 绘制雷达图
            const chartImgUrl = radarChart.toBase64Image();
            const chartImg = new Image();
            chartImg.onload = function() {
                // 绘制雷达图 (居中) - 修改点：确保宽高比为 1:1 避免挤压
                ctx.drawImage(chartImg, (width - 400)/2, 390, 400, 400);

                // 4. 绘制六维能力详情表 (2x3 对称网格)
                const startY = 820;
                const gridW = 320;
                const gridH = 100;
                const gap = 20;
                const startX = (width - (gridW * 2 + gap)) / 2;

                dimensions.forEach((dim, idx) => {
                    const col = idx % 2;
                    const row = Math.floor(idx / 2);
                    const x = startX + col * (gridW + gap);
                    const y = startY + row * (gridH + gap);
                    const score = finalScoresForDownload[idx];
                    const def = DIMENSION_DEFS[dim];

                    // 绘制卡片背景
                    ctx.fillStyle = '#ffffff';
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.05)';
                    ctx.shadowBlur = 10;
                    ctx.shadowOffsetY = 5;
                    roundRect(ctx, x, y, gridW, gridH, 12, true);
                    ctx.shadowColor = 'transparent';

                    // 绘制内容
                    ctx.textAlign = 'left';
                    
                    // 维度名
                    ctx.fillStyle = '#1e293b';
                    ctx.font = 'bold 18px "PingFang SC", sans-serif';
                    ctx.fillText(dim, x + 20, y + 35);

                    // 分数
                    let scoreColor = score >= 80 ? '#059669' : (score >= 60 ? '#4f46e5' : '#d97706');
                    ctx.fillStyle = scoreColor;
                    ctx.font = 'bold 24px "PingFang SC", sans-serif';
                    ctx.textAlign = 'right';
                    ctx.fillText(score, x + gridW - 20, y + 35);

                    // 定义 (小字)
                    ctx.textAlign = 'left';
                    ctx.fillStyle = '#94a3b8';
                    ctx.font = '12px "PingFang SC", sans-serif';
                    ctx.fillText(def, x + 20, y + 70);
                });

                // 5. 底部版权
                ctx.textAlign = 'center';
                ctx.fillStyle = '#cbd5e1';
                ctx.font = '14px "PingFang SC", sans-serif';
                ctx.fillText('© 安清酉 · 商业体质诊断系统', width / 2, 1300);

                // 修改点：不直接下载，而是展示弹窗供用户长按保存
                const dataUrl = canvas.toDataURL('image/png');
                document.getElementById('generatedImage').src = dataUrl;
                document.getElementById('imageModal').classList.remove('hidden');
                document.getElementById('imageModal').classList.add('flex');
            };
            chartImg.src = chartImgUrl;
        }

        function closeImageModal() {
            document.getElementById('imageModal').classList.add('hidden');
            document.getElementById('imageModal').classList.remove('flex');
        }

        // 辅助函数：绘制圆角矩形
        function roundRect(ctx, x, y, width, height, radius, fill) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
            if (fill) ctx.fill();
        }

    </script>
</body>
</html>
